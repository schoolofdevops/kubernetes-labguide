<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gourav Shah" /><link rel="canonical" href="http://kubernetes-tutorial.schoolofdevops.com/argo_adv_prom_exp_analysis/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Lab K704 - Experiments and Analysis - Kubernetes Tutorial with CKA/CKAD Prep</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab K704 - Experiments and Analysis";
        var mkdocs_page_input_path = "argo_adv_prom_exp_analysis.md";
        var mkdocs_page_url = "/argo_adv_prom_exp_analysis/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "UA-36802546-16", "kubernetes-tutorial.schoolofdevops.com");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Kubernetes Tutorial with CKA/CKAD Prep
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Docker Essentials for Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../operating-docker-containers/">Lab D101 - Operating Containers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../building-publishing-docker-images/">Lab D102 - Building and Publishing Docker Images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docker-networking/">Lab D103 - Docker Networking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docker-volumes/">Lab D104 - Docker Volumes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes Essentials for CKA/CKAD</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../kind_create_cluster/">Lab K101 - Install Kubernetes with KIND</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes_quickdive/">Lab K102 - Kubernetes Quickdive</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../create-and-deploy-kubernetes-pods/">Lab K103 - Pods</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-replicasets-howto/">Lab K104 - Namespaces and ReplicaSets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-service-networking/">Lab K105 - Service Networking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-rollouts-rollbacks-deployments/">Lab K107 - Deployments</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-dynamic-storage-provisioning/">Lab K108 - Storage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-sample-project/">Lab K109 - Mini Project</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-configuration-management-configmaps-secrets/">Lab K110 - ConfigMaps & Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ingress/">Lab K112 - Ingress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm/">Lab K113 - HELM Package Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm_charts/">Lab K114 - Writing HELM Charts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm_charts_publish/">Lab K115 - Publishing HELM Charts</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional CKAD Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../advanced_pod_design/">Lab K201 - Advanced Pod Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pods-health-probes/">Lab K204 - Health Checks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../daemonsets_cronsjobs/">Lab K205 - DaemonsSets & CronJobs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../13_redis_statefulset/">Lab K206 - Statefulsets</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional CKA Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../10_kubernetes_autoscaling/">Lab K301 - Auto Scaling with HPA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../custom_autoscaling/">Lab K302 - Autoscaling on Custom Metric</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../advanced_pod_scheduling/">Lab K303 - Advanced Pod Scheduling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cluster-administration/">Lab K304 - Cluster Administration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cluster-troubleshooting/">Lab K305 - Cluster Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes Security</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../rbac_101/">Lab K111 - RBAC Policies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../network_policies/">Lab K207 - Network Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../install_kubernetes_with_kubeadm/">Lab K400 - Install Kubernetes with Kubeadm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../configuring_authentication_and_authorization/">Lab K401 - Creating Users, Groups and Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../vote-deployement_strategies/">Lab K403 - Building Deployment Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cni/">Lab K404 - CNI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../operator/">Lab K404 - Kubernetes Operators</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../12_troubleshooting/">Troubleshooting Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">AWS and Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../aws_ack_demo/">Lab K405 - AWS Controller for Kubernetes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">AWS EKS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_prep/">Lab K501 - EKS Preparatory Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_setup/">Lab K502 - EKS Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_deploy_apps/">Lab K503 - Deploy Apps on EKS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_ingress_alb/">Lab K504 - Ingress with ALB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_storage/">Lab K505 - Persistent Storage with EBS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_irsa/">Lab K506 - IRSA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_cluster_autoscaler/">Lab K507 - EKS Cluster Autoscaler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_vpa/">Lab K509 - Verticle Pod Autoscaler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_monitoring/">Lab K510 - EKS Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_costs/">Lab K511 - EKS Costs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_cleanup/">Lab K599 - EKS Cleanup</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../kind_create_cluster/">Lab K601 - Setup Kubernetes Cluster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_rollout_blue_green/">Lab K602 - Blue/Green with Argo Rollouts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_rollout_canary/">Lab K603 - Canary with Argo Rollouts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_env_deploy/">Lab K604 - ArgoCD</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../argo_workflow_examples.md">Lab K605 - Argo Workflow Examples</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_workflow_ci/">Lab K606 - CI Pipeline with Argo Workflows</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_events/">Lab K607 - Argo Events</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_iamge_updater/">Lab K608 - Argo Image Updater</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_experiments_analysis/">Lab K609 - Experiments and Analysis</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo Articles</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_adv_sync_strategies/">ArgoCD Advanced Sync Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_resource_lifecycle/">ArgoCD Resource Lifecycle Management</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_sync_options/">ArgoCD Sync Options</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_serversideapply/">ArgoCD - Server Side Apply</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_retry_options/">ArgoCD - RETRY Options</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_prune_propogation_policy/">ArgoCD - Prune Propogation Policy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gha_code_explain/">GitHub Actions Code Explainer</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo Advanced</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_setup/">Lab K701 - Setup CI/CD with GHA and Argo</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_tenant/">Lab K702 - Building Multi-Tenant Deployment System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_sync/">Lab K703 - Advanced Sync Strategues</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Lab K704 - Experiments and Analysis</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#setup-metrics-server">Setup Metrics Server</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deploy-prometheus-and-grafana">Deploy Prometheus and Grafana</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#redeploy-nginx-ingress-controller">Redeploy Nginx Ingress Controller</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setup-grafana-dashboard-for-nginx-ingress-controller">Setup Grafana Dashboard for Nginx Ingress Controller</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#updated-rollout-configuration-with-experiment-and-analysis">Updated Rollout Configuration with Experiment and Analysis</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#explanation">Explanation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#how-it-works">How it Works</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#template-for-load-testing">Template for Load Testing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#analysistemplate-for-prometheus-metrics">AnalysisTemplate for Prometheus Metrics</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#fitness-test-for-canary">Fitness Test for Canary</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#update-helm-for-prod">Update HELM for Prod</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_env_deploy/">Lab K704 - TBA</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../argo_workflow_examples.md">Lab K705 - TBA</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Exercises</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../xer-001-pods/">XER001 - Pods</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv-k8s-project/">XER003 - Deploy Instavote Stack</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Web Quests</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Kubernetes Tutorial with CKA/CKAD Prep</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Argo Advanced &raquo;</li>
      <li class="breadcrumb-item active">Lab K704 - Experiments and Analysis</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/schoolofdevops/kubernetes-labguide/edit/master/chapters/argo_adv_prom_exp_analysis.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="analysis-and-experiments">Analysis and Experiments</h1>
<h2 id="setup-metrics-server">Setup Metrics Server</h2>
<p>If you try to pull monitoring information using the following commands</p>
<pre><code>kubectl top pod

kubectl top node
</code></pre>
<p>it does not show it, rather gives you a error message similar to</p>
<p>[output]</p>
<pre><code>Error from server (NotFound): the server could not find the requested resource (get services http:heapster:)
</code></pre>
<p>Even though the error mentions heapster, its replaced with metrics server by default now.</p>
<p>Deploy metric server with the following commands,</p>
<pre><code>cd ~
git clone https://github.com/schoolofdevops/metrics-server.git
kubectl apply -k metrics-server/manifests/overlays/release
</code></pre>
<p>Validate</p>
<pre><code>kubectl get deploy,pods -n kube-system --selector='k8s-app=metrics-server'
</code></pre>
<p>You could validate again with</p>
<pre><code>kubectl top pod

kubectl top node
</code></pre>
<p>where expected output should be similar to,</p>
<pre><code>kubectl top node

NAME                 CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
kind-control-plane   123m         6%     688Mi           17%
kind-worker          39m          1%     498Mi           12%
kind-worker2         31m          1%     422Mi           10%
</code></pre>
<p>If you see a similar output, monitoring is now been setup.</p>
<h2 id="deploy-prometheus-and-grafana">Deploy Prometheus and Grafana</h2>
<p>Set up repository</p>
<pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
</code></pre>
<p>Install Prometheus and Grafana as</p>
<pre><code>helm upgrade --install prom -n monitoring \
  prometheus-community/kube-prometheus-stack \
  --create-namespace \
  --set grafana.service.type=NodePort \
  --set grafana.service.nodePort=30500 \
  --set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false \
  --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false
</code></pre>
<p>Login using</p>
<pre><code>User : admin
Pass: prom-operator
</code></pre>
<h3 id="redeploy-nginx-ingress-controller">Redeploy Nginx Ingress Controller</h3>
<p>First, uninstall nginx ingress conroller as,</p>
<pre><code>helm un ingress-nginx -n ingress-nginx
</code></pre>
<p>Re deploy nginx ingress controller with helm, this time enabling the exposing the metrics which can then be scraped/collected by prometheus.</p>
<pre><code>helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace \
  --set controller.metrics.enabled=true \
  --set controller.metrics.serviceMonitor.enabled=true --set \ controller.metrics.serviceMonitor.additionalLabels.release=&quot;prometheus&quot; \
  --set controller.hostPort.enabled=true \
  --set controller.hostPort.ports.http=80 \
  --set controller.hostPort.ports.https=443 \
  --set controller.service.type=NodePort \
  --set-string controller.nodeSelector.&quot;kubernetes\.io/os&quot;=linux \
  --set-string controller.nodeSelector.ingress-ready=&quot;true&quot;

</code></pre>
<h3 id="setup-grafana-dashboard-for-nginx-ingress-controller">Setup Grafana Dashboard for Nginx Ingress Controller</h3>
<p>Now, login to grafana and import custom dashboard for Nginx Ingress as</p>
<ul>
<li>Left menu (hover over +) -&gt; Dashboard</li>
<li>Click New -&gt; Import"</li>
<li>Enter the copy pasted json from <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/grafana/dashboards/nginx.json">https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/grafana/dashboards/nginx.json</a></li>
<li>Click <code>Import JSON / Load</code></li>
<li>Select the Prometheus data source</li>
<li>Click "Import"</li>
</ul>
<p>⠀
It may look similar to this, with possibly less data initially
<img alt="" src="../images/grafana-01.png" /></p>
<p>However, if you see some metric coming in, your setup with Nginx Ingress and Promethus Integration is working ! You may pat your back at this time :)</p>
<hr />
<h3 id="updated-rollout-configuration-with-experiment-and-analysis">Updated Rollout Configuration with Experiment and Analysis</h3>
<p>File: <code>instavote-gitops/charts/vote/env/prod.yaml</code></p>
<pre><code>canary:
  steps:
    - setCanaryScale:
        replicas: 2
    - experiment:
        duration: 3m
        templates:
        - name: canary
          specRef: canary
          service:
            name: experiment
        analyses:
          - name: fitness-test
            templateName: canary-fitness-test
    - setWeight: 20
    - pause:
        duration: 10s
    - setWeight: 40
    - pause:
        duration: 10s
    - setWeight: 60
    - analysis:
        templates:
        - templateName: loadtest
        - templateName: latency
    - setWeight: 80
    - pause:
        duration: 10s
    - setWeight: 100
</code></pre>
<h4 id="explanation">Explanation</h4>
<ul>
<li>
<p><strong>Rollout Configuration</strong>:</p>
</li>
<li>
<p>The rollout strategy includes canary steps with set weights and pauses.  </p>
</li>
<li>Each canary step includes an experiment with a specified duration (e.g., 3 minutes).  </li>
<li>The experiment step runs a experimental replicaset and launches a fitness test to  validate if the new version looks okay.  </li>
<li>
<p>After 60% traffic is shifted to canary, a load test is lauched along with analysis from prometheus to check if the new version will perform okay with the load.  </p>
</li>
<li>
<p><strong>Analysis Templates</strong>:</p>
</li>
<li>
<p>Defines a templates for running various tests and analyses.    </p>
</li>
<li>The <code>loadtest</code> container runs the load testing script against the canary service (<code>vote-preview</code>).  </li>
<li>The <code>fitness-test</code> job runs a test to validate if the new version is fit for deployment.  </li>
<li>the <code>latency</code> analysis fetches latency metrics from Prometheus and checks if the application is responding in acceptable time frame even with load conditions.  </li>
</ul>
<p>⠀</p>
<h4 id="how-it-works">How it Works</h4>
<ul>
<li>At each setWeight step, traffic is gradually shifted to the canary version.  </li>
<li>The analysis step includes both the load test and the metric analysis.  </li>
<li>The experiment runs for 3 minutes, during which the fitness test is conducted.  </li>
<li>Simultaneously with load test , the analysis template checks Prometheus metrics to ensure the canary is performing correctly.  </li>
<li>If the analysis detects errors beyond the acceptable threshold, the rollout will trigger a rollback.  </li>
<li>If the canary passes the load test and analysis, the rollout proceeds to the next step.  </li>
</ul>
<p>⠀
By configuring the experiment and analysis to run in parallel, you can ensure comprehensive testing and validation of the canary version, enabling automatic rollback if any issues are detected.</p>
<h3 id="template-for-load-testing">Template for Load Testing</h3>
<p>File <code>intstavote-gitops/charts/vote/templates/loadtest-analysistemplate.yaml</code></p>
<pre><code>apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: loadtest
spec:
  metrics:
  - name: loadtest-vote
    provider:
      job:
        spec:
          template:
            spec:
              containers:
              - name: siege
                image: schoolofdevops/loadtest:v1
                command:
                  - siege
                  - &quot;--concurrent=2&quot;
                  - &quot;--benchmark&quot;
                  - &quot;--time=5m&quot;
                  - &quot;--header='X-Canary: siege'&quot;
                  - &quot;http://vote.example.com&quot;
              restartPolicy: Never
              hostAliases:
              - ip: &quot;xx.xx.xx.xx&quot;
                hostnames:
                - &quot;vote.example.com&quot;
          backoffLimit: 4
</code></pre>
<p>where,
* replace <code>xx.xx.xx.xx</code> with internal IP Address of <code>kind-worker</code> node which runs nginx. Find out by using</p>
<pre><code>kubectl get nodes -o wide
</code></pre>
<p>[sample output]</p>
<pre><code>NAME                 STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME
kind-control-plane   Ready    control-plane   2d23h   v1.30.0   172.18.0.2    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   6.8.0-31-generic   containerd://1.7.15
kind-worker          Ready    &lt;none&gt;          2d23h   v1.30.0   172.18.0.4    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   6.8.0-31-generic   containerd://1.7.15
kind-worker2         Ready    &lt;none&gt;          2d23h   v1.30.0   172.18.0.3    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   6.8.0-31-generic   containerd://1.7.15
</code></pre>
<p>From this output, you are going to use <code>172.18.0.4</code> in the configuration above.</p>
<h3 id="analysistemplate-for-prometheus-metrics">AnalysisTemplate for Prometheus Metrics</h3>
<p>File : <code>intstavote-gitops/charts/vote/templates/latency-analysistemplate.yaml</code></p>
<pre><code>apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: latency
spec:
  metrics:
  - name: nginx-latency-ms
    initialDelay: 1m
    interval: 1m
    failureLimit: 2
    count: 4
    successCondition: result &lt; 50.0
    failureCondition: result &gt;= 50.0
    provider:
      prometheus:
        address: http://prom-kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090
        query: |
          scalar(
            1000 * histogram_quantile(0.99,
              sum(
                rate(
                  nginx_ingress_controller_request_duration_seconds_bucket{ingress=&quot;vote&quot;, exported_namespace=&quot;prod&quot;}[1m]
                )
              ) by (le)
            )
          )
</code></pre>
<h3 id="fitness-test-for-canary">Fitness Test for Canary</h3>
<p>File: <code>intstavote-gitops/charts/vote/templates/fitness-analysistemplate.yaml</code></p>
<pre><code>apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: canary-fitness-test
spec:
  metrics:
  - name: canary-fitness
    interval: 30s
    count: 3
    successCondition: result == &quot;true&quot;
    failureLimit: 1
    provider:
      job:
        spec:
          template:
            spec:
              containers:
              - name: fitness-test
                image: curlimages/curl
                command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
                args:
                - |
                  FITNESS_RESULT=&quot;false&quot;
                  CANARY_SERVICE_URL=&quot;http://vote-canary&quot;

                  # Perform the fitness test
                  RESPONSE=$(curl -s $CANARY_SERVICE_URL)

                  # Check if the response contains the expected string
                  if [[ &quot;$RESPONSE&quot; == *&quot;Processed by container ID&quot;* ]]; then
                    FITNESS_RESULT=&quot;true&quot;
                  fi

                  # Return the fitness test result
                  echo $FITNESS_RESULT
              restartPolicy: Never
          backoffLimit: 1
</code></pre>
<p>where, replace <code>CANARY_SERVICE_URL="http://vote-canary"</code> with the actual URL of the canary service.</p>
<h3 id="update-helm-for-prod">Update HELM for Prod</h3>
<p>validate </p>
<pre><code>helm template vote --values env/prod.yaml .
</code></pre>
<p>commit and push to git</p>
<pre><code>git status
git add *
git status
git commit -am &quot;added fitness test and prometheus analysis&quot;

</code></pre>
<p>If you are mapping prod to release branch, raise a PR and merge the changes to release branch.</p>
<p>watch the rollout using</p>
<pre><code>kubectl argo rollouts list rollout -A
watch kubectl argo rollouts get rollout  vote-prod -n instavote-prod
</code></pre>
<hr />
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../argo_adv_sync/" class="btn btn-neutral float-left" title="Lab K703 - Advanced Sync Strategues"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../argo_multi_env_deploy/" class="btn btn-neutral float-right" title="Lab K704 - TBA">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright @ 2017-2020 Gourav Shah, School of Devops. Some rights reserved. License CC BY-NC-SA</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/schoolofdevops/kubernetes-labguide" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../argo_adv_sync/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../argo_multi_env_deploy/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
