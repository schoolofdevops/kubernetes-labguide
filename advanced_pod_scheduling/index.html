<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gourav Shah" /><link rel="canonical" href="http://kubernetes-tutorial.schoolofdevops.com/advanced_pod_scheduling/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Lab K303 - Advanced Pod Scheduling - Kubernetes Tutorial with CKA/CKAD Prep</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab K303 - Advanced Pod Scheduling";
        var mkdocs_page_input_path = "advanced_pod_scheduling.md";
        var mkdocs_page_url = "/advanced_pod_scheduling/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "UA-36802546-16", "kubernetes-tutorial.schoolofdevops.com");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Kubernetes Tutorial with CKA/CKAD Prep
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Docker Essentials for Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../operating-docker-containers/">Lab D101 - Operating Containers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../building-publishing-docker-images/">Lab D102 - Building and Publishing Docker Images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docker-networking/">Lab D103 - Docker Networking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docker-volumes/">Lab D104 - Docker Volumes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes Essentials for CKA/CKAD</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../kind_create_cluster/">Lab K101 - Install Kubernetes with KIND</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes_quickdive/">Lab K102 - Kubernetes Quickdive</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../create-and-deploy-kubernetes-pods/">Lab K103 - Pods</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-replicasets-howto/">Lab K104 - Namespaces and ReplicaSets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-service-networking/">Lab K105 - Service Networking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-rollouts-rollbacks-deployments/">Lab K107 - Deployments</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-dynamic-storage-provisioning/">Lab K108 - Storage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-sample-project/">Lab K109 - Mini Project</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-configuration-management-configmaps-secrets/">Lab K110 - ConfigMaps & Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ingress/">Lab K112 - Ingress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm/">Lab K113 - HELM Package Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm_charts/">Lab K114 - Writing HELM Charts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm_charts_publish/">Lab K115 - Publishing HELM Charts</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional CKAD Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../advanced_pod_design/">Lab K201 - Advanced Pod Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pods-health-probes/">Lab K204 - Health Checks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../daemonsets_cronsjobs/">Lab K205 - DaemonsSets & CronJobs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../13_redis_statefulset/">Lab K206 - Statefulsets</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional CKA Topics</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../10_kubernetes_autoscaling/">Lab K301 - Auto Scaling with HPA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../custom_autoscaling/">Lab K302 - Autoscaling on Custom Metric</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Lab K303 - Advanced Pod Scheduling</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#nodename">nodeName</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#nodeselector">nodeSelector</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#affinity-and-anti-affinity">Affinity and Anti-Affinity</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#nodeaffinity">nodeAffinity</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#podaffinity-and-podantiaffinity">podAffinity and podAntiAffinity</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#taints-and-tolerations">Taints and Tolerations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#exercise">Exercise</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cluster-administration/">Lab K304 - Cluster Administration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cluster-troubleshooting/">Lab K305 - Cluster Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes Security</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../rbac_101/">Lab K111 - RBAC Policies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../network_policies/">Lab K207 - Network Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../install_kubernetes_with_kubeadm/">Lab K400 - Install Kubernetes with Kubeadm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../configuring_authentication_and_authorization/">Lab K401 - Creating Users, Groups and Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../vote-deployement_strategies/">Lab K403 - Building Deployment Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cni/">Lab K404 - CNI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../operator/">Lab K404 - Kubernetes Operators</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../12_troubleshooting/">Troubleshooting Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">AWS and Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../aws_ack_demo/">Lab K405 - AWS Controller for Kubernetes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">AWS EKS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_prep/">Lab K501 - EKS Preparatory Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_setup/">Lab K502 - EKS Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_deploy_apps/">Lab K503 - Deploy Apps on EKS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_ingress_alb/">Lab K504 - Ingress with ALB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_storage/">Lab K505 - Persistent Storage with EBS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_irsa/">Lab K506 - IRSA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_cluster_autoscaler/">Lab K507 - EKS Cluster Autoscaler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_vpa/">Lab K509 - Verticle Pod Autoscaler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_monitoring/">Lab K510 - EKS Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_costs/">Lab K511 - EKS Costs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_cleanup/">Lab K599 - EKS Cleanup</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../kind_create_cluster/">Lab K601 - Setup Kubernetes Cluster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_rollout_blue_green/">Lab K602 - Blue/Green with Argo Rollouts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_rollout_canary/">Lab K603 - Canary with Argo Rollouts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_env_deploy/">Lab K604 - ArgoCD</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../argo_workflow_examples.md">Lab K605 - Argo Workflow Examples</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_workflow_ci/">Lab K606 - CI Pipeline with Argo Workflows</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_events/">Lab K607 - Argo Events</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_iamge_updater/">Lab K608 - Argo Image Updater</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_experiments_analysis/">Lab K609 - Experiments and Analysis</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo Articles</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_adv_sync_strategies/">ArgoCD Advanced Sync Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_resource_lifecycle/">ArgoCD Resource Lifecycle Management</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_sync_options/">ArgoCD Sync Options</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_serversideapply/">ArgoCD - Server Side Apply</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_retry_options/">ArgoCD - RETRY Options</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_prune_propogation_policy/">ArgoCD - Prune Propogation Policy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gha_code_explain/">GitHub Actions Code Explainer</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo Advanced</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_setup/">Lab K701 - Setup CI/CD with GHA and Argo</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_tenant/">Lab K702 - Building Multi-Tenant Deployment System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_sync/">Lab K703 - Advanced Sync Strategues</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_prom_exp_analysis/">Lab K704 - Experiments and Analysis</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_env_deploy/">Lab K704 - TBA</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../argo_workflow_examples.md">Lab K705 - TBA</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Exercises</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../xer-001-pods/">XER001 - Pods</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv-k8s-project/">XER003 - Deploy Instavote Stack</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Web Quests</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Kubernetes Tutorial with CKA/CKAD Prep</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Additional CKA Topics &raquo;</li>
      <li class="breadcrumb-item active">Lab K303 - Advanced Pod Scheduling</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/schoolofdevops/kubernetes-labguide/edit/master/chapters/advanced_pod_scheduling.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-k203-advanced-pod-scheduling">Lab K203 - Advanced Pod Scheduling</h1>
<p>In the Kubernetes bootcamp training, we have seen how to create a pod and and some basic pod configurations to go with it. But this chapter explains some advanced topics related to pod scheduling.</p>
<p>From the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#pod-v1-core">api document for version 1.11</a> following are the pod specs which are relevant from scheduling perspective.</p>
<ul>
<li>nodeSelector</li>
<li>nodeName</li>
<li>affinity</li>
<li>schedulerName</li>
<li>tolerations</li>
</ul>
<h2 id="nodename">nodeName</h2>
<p>You could bind a pod to a specific node with a name using nodeName spec. Lets take an example where you want to run the deployment for <code>result</code> service on a specific node. Lets look at how you would do it,</p>
<p>Begin by listing the nodes</p>
<pre><code>kubectl get nodes
</code></pre>
<p>[sample output]</p>
<pre><code>NAME                 STATUS   ROLES           AGE   VERSION
kind-control-plane   Ready    control-plane   35h   v1.29.2
kind-worker          Ready    &lt;none&gt;          35h   v1.29.2
kind-worker2         Ready    &lt;none&gt;          35h   v1.29.2
</code></pre>
<p>Now, bind your pod to one node e.g. <code>kind-worker</code> by modyfying the deployment spec as:</p>
<p>File : <code>result-deploy.yaml</code></p>
<pre><code>apiVersion: apps/v1
kind: Deployment
....
.....
spec:
  containers:
  - image: schoolofdevops/vote-result
    name: vote-result
  nodeName: kind-worker
</code></pre>
<p>apply and validate</p>
<pre><code>kubectl apply -f result-deploy.yaml
kubectl get pods -o wide
</code></pre>
<h2 id="nodeselector">nodeSelector</h2>
<p>Using nodeSelector instead of directly specifying nodeName in Kubernetes offers greater flexibility and resilience in scheduling pods. While nodeName forces a pod to schedule on a specific node, effectively bypassing Kubernetes' scheduler, nodeSelector allows for more dynamic placement by specifying a set of criteria that nodes must meet for the pod to be scheduled there. This approach utilizes Kubernetes' intelligent scheduling capabilities, enabling the system to consider multiple suitable nodes that meet the specified labels. This not only improves fault tolerance by avoiding dependencies on a single node but also facilitates more efficient resource utilization across the cluster. Additionally, nodeSelector supports scenarios where the environment might change, such as when nodes are added or removed, or their labels are updated, ensuring that the pods can still be scheduled according to the current state of the cluster.</p>
<p>To use nodeSelector, begin by labeling your nodes as:</p>
<pre><code>kubectl get nodes --show-labels

kubectl label nodes &lt;node-name&gt; zone=aaa

kubectl get nodes --show-labels

</code></pre>
<p>e.g.</p>
<pre><code>kubectl label nodes kind-worker zone=aaa
kubectl label nodes kind-worker2 zone=bbb
kubectl get nodes --show-labels
</code></pre>
<p>where, replace <strong>kind-worker</strong> and <strong>kind-worker2</strong> can be the  the actual nodes in your cluster.</p>
<p>Now update one of the deployments and add the nodeSelector spec to the pod  e.g.</p>
<p>File : <code>result-deploy.yaml</code></p>
<pre><code>spec:
  containers:
  - image: schoolofdevops/vote-result
    name: vote-result
  nodeSelector:
    zone: bbb
</code></pre>
<p><code>Note: ensure you have removed nodeName if present.</code></p>
<p>apply and validate</p>
<pre><code>kubectl apply -f result-deploy.yaml
kubectl get pods -o wide
</code></pre>
<p>You shall see the pod being recreated now on the node matching the label selected using nodeSelector.</p>
<h2 id="affinity-and-anti-affinity">Affinity and Anti-Affinity</h2>
<p>We have discussed about scheduling a pod on a particular node using <strong>NodeSelector</strong>. Using affinity and anti-affinity in Kubernetes offers a more sophisticated and granular level of control compared to nodeSelector, enabling not just simple label matching but also complex rules that govern pod placement. Affinity rules allow you to specify preferences that attract pods to certain nodes, either based on the node's properties or other pods that are already running on those nodes. Conversely, anti-affinity rules are used to ensure pods are spread across different nodes or node groups, enhancing high availability and reducing the risk of simultaneous failures. This is particularly useful in large-scale deployments where maintaining workload balance and resilience is crucial. For example, you can ensure that multiple instances of a service run in different racks or availability zones, minimizing potential impact from physical infrastructure failures. These features allow Kubernetes to more effectively manage the distribution and redundancy of workloads, which is vital for maintaining robust, scalable applications.</p>
<p>More over,  using nodeSelector wolud mean defining a strict condition which must be met. If the condition is not met, the pod cannot be scheduled. Node/Pod affinity and anti-affinity solves this issue by introducing soft and hard conditions which are flexible based on when they are applied. This is controlled using the following properties</p>
<ul>
<li>required</li>
<li>
<p>preferred</p>
</li>
<li>
<p>DuringScheduling</p>
</li>
<li>DuringExecution</li>
</ul>
<p>and using theese operators</p>
<ul>
<li>In</li>
<li>NotIn</li>
<li>Exists</li>
<li>DoesNotExist</li>
<li>Gt</li>
<li>Lt</li>
</ul>
<p>Lets take up some examples and understand this.</p>
<h3 id="nodeaffinity">nodeAffinity</h3>
<p>Examine  the current pod distribution  </p>
<pre><code>kubectl get pods -o wide --selector=&quot;role=vote&quot;

</code></pre>
<p>and node labels</p>
<pre><code>kubectl get nodes --show-labels

</code></pre>
<p>Lets create node affinity criteria as</p>
<ul>
<li>Pods for vote app <strong>must</strong> not run on the master nodes</li>
<li>Pods for vote app <strong>preferably</strong> run on a node in zone <strong>bbb</strong></li>
</ul>
<p>First is a <strong>hard</strong> affinity versus second being <strong>soft</strong> affinity.</p>
<p><code>file: vote-deploy-nodeaffinity.yaml</code></p>
<pre><code>....
  template:
....
    spec:
      containers:
        - name: app
          image: schoolofdevops/vote:v1
          ports:
            - containerPort: 80
              protocol: TCP

              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                    - matchExpressions:
                      - key: node-role.kubernetes.io/control-plane
                        operator: DoesNotExist
                  preferredDuringSchedulingIgnoredDuringExecution:
                    - weight: 1
                      preference:
                        matchExpressions:
                        - key: zone
                          operator: In
                          values:
                            - bbb
</code></pre>
<p>clearn up previous deployment and apply this code as</p>
<pre><code>kubectl delete deploy vote

kubectl apply -f vote-deploy-nodeaffinity.yaml

kubectl get pods -o wide
</code></pre>
<h3 id="podaffinity-and-podantiaffinity">podAffinity and podAntiAffinity</h3>
<p>Lets define pod affinity criteria as,</p>
<ul>
<li>Pods for <strong>vote</strong> and <strong>redis</strong> should be co located as much as possible (preferred)</li>
<li>No two pods with <strong>redis</strong> app should be running on the same node (required)</li>
</ul>
<pre><code>kubectl get pods -o wide --selector=&quot;role in (vote,redis)&quot;

</code></pre>
<p><code>file: vote-deploy-podaffinity.yaml</code></p>
<pre><code>...
    template:
...
    spec:
      containers:
        - name: app
          image: schoolofdevops/vote:v1
          ports:
            - containerPort: 80
              protocol: TCP

      affinity:
...

        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                  - key: role
                    operator: In
                    values:
                    - redis
                topologyKey: kubernetes.io/hostname
</code></pre>
<p><code>file: redis-deploy-podaffinity.yaml</code></p>
<pre><code>....
  template:
...
    spec:
      containers:
      - image: schoolofdevops/redis:latest
        imagePullPolicy: Always
        name: redis
        ports:
        - containerPort: 6379
          protocol: TCP
      restartPolicy: Always

      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: role
                operator: In
                values:
                - redis
            topologyKey: &quot;kubernetes.io/hostname&quot;
</code></pre>
<p>clean up the previous deployments and apply as</p>
<pre><code>kubectl delete deploy vote
kubectl delete deploy,sts redis

kubectl apply -f redis-deploy-podaffinity.yaml
kubectl apply -f vote-deploy-podaffinity.yaml


</code></pre>
<p>check the pods distribution</p>
<pre><code>kubectl get pods -o wide --selector=&quot;role in (vote,redis)&quot;
</code></pre>
<p>Observations from the above output,</p>
<ul>
<li>Since redis has a hard constraint not to be on the same node, you would observe redis pods being on differnt nodes  (node2 and node4)</li>
<li>since vote app has a soft constraint, you see some of the pods running on node4 (same node running redis), others continue to run on node 3</li>
</ul>
<p>If you kill the pods on node3, at the time of  scheduling new ones, scheduler meets all affinity rules</p>
<p>Now try scaling up redis instances</p>
<pre><code>kubectl scale deploy/redis --replicas=4
kubectl get pods -o wide
</code></pre>
<ul>
<li>Are all redis pods runnning ? Why?</li>
</ul>
<p>When you are done experimenting, revert to original configurations</p>
<pre><code>kubectl delete deploy vote
kubectl delete deploy redis
kubectl apply -f vote-deploy.yaml -f redis-deploy.yaml
</code></pre>
<h2 id="taints-and-tolerations">Taints and Tolerations</h2>
<ul>
<li>Affinity is defined for pods</li>
<li>Taints are defined for nodes</li>
</ul>
<p>You could add the taints with criteria and effects. Effetcs can be</p>
<p><strong>Taint Specs</strong>:   </p>
<ul>
<li>effect  <ul>
<li>NoSchedule  </li>
<li>PreferNoSchedule  </li>
<li>NoExecute  </li>
</ul>
</li>
<li>key  </li>
<li>value  </li>
<li>timeAdded (only written for NoExecute taints)  </li>
</ul>
<p>Observe the pods distribution</p>
<pre><code>kubectl get pods -o wide

</code></pre>
<p>Lets taint a node.</p>
<pre><code>kubectl taint node kind-worker2 dedicated=worker:NoExecute

kubectl describe node kind-worker2
</code></pre>
<p>after tainting the node</p>
<pre><code>kubectl get pods -o wide
</code></pre>
<p>All pods running on node2 just got evicted.</p>
<p>Add toleration in the Deployment for worker.</p>
<p><code>File: worker-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1
.....
  template:
....
    spec:
      containers:
        - name: app
          image: schoolofdevops/vote-worker:latest

      tolerations:
        - key: &quot;dedicated&quot;
          operator: &quot;Equal&quot;
          value: &quot;worker&quot;
          effect: &quot;NoExecute&quot;
</code></pre>
<p>apply</p>
<pre><code>kubectl apply -f worker-deploy.yml

</code></pre>
<p>Observe the pod distribution now.</p>
<pre><code>$ kubectl get pods -o wide
NAME                      READY     STATUS    RESTARTS   AGE       IP             NODE
db-66496667c9-qggzd       1/1       Running   0          4h        10.233.74.74   node4
redis-5bf748dbcf-ckn65    1/1       Running   0          3m        10.233.71.26   node3
redis-5bf748dbcf-vxppx    1/1       Running   0          31m       10.233.74.79   node4
result-5c7569bcb7-4fptr   1/1       Running   0          4h        10.233.71.18   node3
result-5c7569bcb7-s4rdx   1/1       Running   0          4h        10.233.74.75   node4
vote-56bf599b9c-22lpw     1/1       Running   0          30m       10.233.74.80   node4
vote-56bf599b9c-4l6bc     1/1       Running   0          12m       10.233.74.83   node4
vote-56bf599b9c-bqsrq     1/1       Running   0          12m       10.233.74.82   node4
vote-56bf599b9c-xw7zc     1/1       Running   0          12m       10.233.74.81   node4
worker-6cc8dbd4f8-6bkfg   1/1       Running   0          1m        10.233.75.15   node2
</code></pre>
<p>You should see worker being scheduled on kind-worker2</p>
<p>To remove the taint created above</p>
<pre><code>kubectl taint node kind-worker2 dedicated=worker:NoExecute-
</code></pre>
<h2 id="exercise">Exercise</h2>
<ul>
<li>Master node is unschedulable because of a taint. Find the taint on the master node and remove it. See if new pods get scheduled on it after that.</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../custom_autoscaling/" class="btn btn-neutral float-left" title="Lab K302 - Autoscaling on Custom Metric"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cluster-administration/" class="btn btn-neutral float-right" title="Lab K304 - Cluster Administration">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright @ 2017-2020 Gourav Shah, School of Devops. Some rights reserved. License CC BY-NC-SA</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/schoolofdevops/kubernetes-labguide" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../custom_autoscaling/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cluster-administration/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
