<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gourav Shah" /><link rel="canonical" href="http://kubernetes-tutorial.schoolofdevops.com/adv_setup_cilium/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Lab K803 - Setting up Cilium CNI with KIND - Kubernetes Tutorial with CKA/CKAD Prep</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab K803 - Setting up Cilium CNI with KIND";
        var mkdocs_page_input_path = "adv_setup_cilium.md";
        var mkdocs_page_url = "/adv_setup_cilium/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "UA-36802546-16", "kubernetes-tutorial.schoolofdevops.com");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Kubernetes Tutorial with CKA/CKAD Prep
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Docker Essentials for Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../operating-docker-containers/">Lab D101 - Operating Containers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../building-publishing-docker-images/">Lab D102 - Building and Publishing Docker Images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docker-networking/">Lab D103 - Docker Networking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docker-volumes/">Lab D104 - Docker Volumes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes Essentials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../kind_create_cluster/">Lab K101 - Install Kubernetes with KIND</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes_quickdive/">Lab K102 - Kubernetes Quickdive</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../create-and-deploy-kubernetes-pods/">Lab K103 - Pods</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-replicasets-howto/">Lab K104 - Namespaces and ReplicaSets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-service-networking/">Lab K105 - Service Networking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-rollouts-rollbacks-deployments/">Lab K107 - Deployments</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-dynamic-storage-provisioning/">Lab K108 - Storage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-sample-project/">Lab K109 - Mini Project</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes-configuration-management-configmaps-secrets/">Lab K110 - ConfigMaps & Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ingress/">Lab K112 - Ingress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm/">Lab K113 - HELM Package Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm_charts/">Lab K114 - Writing HELM Charts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm_charts_publish/">Lab K115 - Publishing HELM Charts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm_charts_single/">Lab K116 - Writing Single HELM Chart</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Advanced Kubernetes</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../adv_kubernetes-setup/">Lab K801 - Setting up Kubernetes Cluster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_kubernetes-control-plane/">Lab K802 - Exploring Kubernetes Control Plane</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_service_networking/">Lab K803 - Service Networking and Kube Proxy</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Lab K803 - Setting up Cilium CNI with KIND</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#setup-cni-with-cilium">Setup CNI with Cilium</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#understanding-the-components">Understanding the Components</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#smoke-test-cilium">Smoke Test Cilium</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-observability-with-hubble">Enable Observability with Hubble</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_explore_cilium/">Lab K804 - Exploring Cilium</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_controllers/">Lab K805 - Controllers and CRDs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_operators/">Lab K806 - Operators</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_operator_go/">Lab K807 - Writing Custom Operator in Go</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_setup_eks_cluster/">Lab K807 - Launch EKS Cluster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_eks_autoscaling/">Lab K808 - Horizontal and Vertical Autoscaling</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional CKAD Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../advanced_pod_design/">Lab K201 - Advanced Pod Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pods-health-probes/">Lab K204 - Health Checks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../daemonsets_cronsjobs/">Lab K205 - DaemonsSets & CronJobs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../13_redis_statefulset/">Lab K206 - Statefulsets</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional CKA Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../10_kubernetes_autoscaling/">Lab K301 - Auto Scaling with HPA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../custom_autoscaling/">Lab K302 - Autoscaling on Custom Metric</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../advanced_pod_scheduling/">Lab K303 - Advanced Pod Scheduling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cluster-administration/">Lab K304 - Cluster Administration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cluster-troubleshooting/">Lab K305 - Cluster Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes Security</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../rbac_101/">Lab K111 - RBAC Policies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../network_policies/">Lab K207 - Network Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../install_kubernetes_with_kubeadm/">Lab K400 - Install Kubernetes with Kubeadm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../configuring_authentication_and_authorization/">Lab K401 - Creating Users, Groups and Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../vote-deployement_strategies/">Lab K403 - Building Deployment Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cni/">Lab K404 - CNI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../operator/">Lab K404 - Kubernetes Operators</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../12_troubleshooting/">Troubleshooting Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">AWS and Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../aws_ack_demo/">Lab K405 - AWS Controller for Kubernetes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">AWS EKS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_prep/">Lab K501 - EKS Preparatory Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_setup/">Lab K502 - EKS Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_deploy_apps/">Lab K503 - Deploy Apps on EKS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_ingress_alb/">Lab K504 - Ingress with ALB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_storage/">Lab K505 - Persistent Storage with EBS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_irsa/">Lab K506 - IRSA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_cluster_autoscaler/">Lab K507 - EKS Cluster Autoscaler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_vpa/">Lab K509 - Verticle Pod Autoscaler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_monitoring/">Lab K510 - EKS Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_costs/">Lab K511 - EKS Costs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eks_cleanup/">Lab K599 - EKS Cleanup</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../kind_create_cluster/">Lab K101 - Install Kubernetes with KIND</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_rollout_blue_green/">Lab K602 - Blue/Green with Argo Rollouts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_rollout_canary/">Lab K603 - Canary with Argo Rollouts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_env_deploy/">Lab K604 - ArgoCD</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../argo_workflow_examples.md">Lab K605 - Argo Workflow Examples</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_workflow_ci/">Lab K606 - CI Pipeline with Argo Workflows</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_events/">Lab K607 - Argo Events</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_iamge_updater/">Lab K608 - Argo Image Updater</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_experiments_analysis/">Lab K609 - Experiments and Analysis</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo Articles</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_adv_sync_strategies/">ArgoCD Advanced Sync Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_resource_lifecycle/">ArgoCD Resource Lifecycle Management</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_sync_options/">ArgoCD Sync Options</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_serversideapply/">ArgoCD - Server Side Apply</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_retry_options/">ArgoCD - RETRY Options</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_prune_propogation_policy/">ArgoCD - Prune Propogation Policy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gha_code_explain/">GitHub Actions Code Explainer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../articles/argo_lua/">Lua Scripting in Argo</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Argo Advanced</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_setup/">Lab K701 - Setup CI/CD with GHA and Argo</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_multi_tenant/">Lab K702 - Building Multi-Tenant Deployment System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_sync/">Lab K703 - Advanced Sync Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_adv_prom_exp_analysis/">Lab K704 - Experiments and Analysis</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../argo_kargo/">Lab K704 - Kargo</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../argo_workflow_examples.md">Lab K705 - TBA</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Exercises</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../xer-001-pods/">XER001 - Pods</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv-k8s-project/">XER003 - Deploy Instavote Stack</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Web Quests</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Kubernetes Tutorial with CKA/CKAD Prep</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Advanced Kubernetes</li>
      <li class="breadcrumb-item active">Lab K803 - Setting up Cilium CNI with KIND</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/schoolofdevops/kubernetes-labguide/edit/master/chapters/adv_setup_cilium.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-3-install-cilium-with-kind">Lab 3 - Install Cilium with KIND</h1>
<p>In this lab, you will reconfigure the KIND Cluster, this time with Cilium. You will redo the cluster, this time with disabled Kindnet CNI and setup Cilium along with Hubble, the observability layer. </p>
<p>To start redoing the cluster, switch to the path from where you setup the KIND environment. and delete the exissting cluster.</p>
<pre><code># Switch to kind config path 

cd /root/k8s-code/helper/kind

kind delete cluster --name kind

</code></pre>
<p>Edit <code>kind-three-node-cluster.yaml</code> with the following changes </p>
<pre><code># three node (two workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  disableDefaultCNI: true
</code></pre>
<p>Create KIND Cluster </p>
<pre><code>kind create cluster --config kind-three-node-cluster.yaml
</code></pre>
<p>[Sample Output ]</p>
<pre><code>Creating cluster &quot;kind&quot; ...
 ‚úì Ensuring node image (kindest/node:v1.32.2) üñº
 ‚úì Preparing nodes üì¶ üì¶ üì¶
 ‚úì Writing configuration üìú
 ‚úì Starting control-plane üïπÔ∏è
 ‚úì Installing StorageClass üíæ
 ‚úì Joining worker nodes üöú
Set kubectl context to &quot;kind-kind&quot;
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Not sure what to do next? üòÖ  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</code></pre>
<p>Validate </p>
<pre><code>kubectl cluster-info --context kind-kind
kubectl get nodes
</code></pre>
<p>[Sample output]</p>
<pre><code># kubectl get nodes

NAME                 STATUS     ROLES           AGE    VERSION
kind-control-plane   NotReady   control-plane   100s   v1.32.2
kind-worker          NotReady   &lt;none&gt;          89s    v1.32.2
kind-worker2         NotReady   &lt;none&gt;          89s    v1.32.2
</code></pre>
<p>Check pods </p>
<pre><code>kubectl get pod -A 
</code></pre>
<pre><code># kubectl get pods -A

NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
kube-system          coredns-668d6bf9bc-l6mdb                     0/1     Pending   0          116s
kube-system          coredns-668d6bf9bc-p4fmn                     0/1     Pending   0          116s
kube-system          etcd-kind-control-plane                      1/1     Running   0          2m4s
kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          2m2s
kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          2m4s
kube-system          kube-proxy-5tsh8                             1/1     Running   0          114s
kube-system          kube-proxy-78jnh                             1/1     Running   0          114s
kube-system          kube-proxy-tzhz2                             1/1     Running   0          116s
kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          2m2s
local-path-storage   local-path-provisioner-7dc846544d-cstmf      0/1     Pending   0          116s
</code></pre>
<p>You shall see some pods e.g. coredns, storage provisionere in pending state. This is because there is no pod networking setup yet. Lets do that with Cilium. </p>
<h2 id="setup-cni-with-cilium">Setup CNI with  Cilium</h2>
<p>You will setup cilium using helm. Install it if its not already available.</p>
<pre><code>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
</code></pre>
<p>Setup cilium helm repo </p>
<pre><code>helm repo add cilium https://helm.cilium.io/
</code></pre>
<p>Setup cilium as </p>
<pre><code>helm install cilium cilium/cilium --version 1.17.2 \
   --namespace kube-system \
   --set image.pullPolicy=IfNotPresent \
   --set ipam.mode=kubernetes
</code></pre>
<p>validate  </p>
<pre><code>helm list -A
</code></pre>
<pre><code>kubectl get all -n kube-system  -l &quot;app.kubernetes.io/part-of=cilium&quot;
</code></pre>
<p>[sample output]</p>
<pre><code>NAME                                   READY   STATUS    RESTARTS   AGE
pod/cilium-6hnq4                       1/1     Running   0          97s
pod/cilium-envoy-khxtw                 1/1     Running   0          97s
pod/cilium-envoy-ktj88                 1/1     Running   0          97s
pod/cilium-envoy-n44m5                 1/1     Running   0          97s
pod/cilium-operator-59944f4b8f-2jj79   1/1     Running   0          97s
pod/cilium-operator-59944f4b8f-jhflt   1/1     Running   0          96s
pod/cilium-qdg5q                       0/1     Running   0          96s
pod/cilium-tj2bh                       1/1     Running   0          96s

NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/cilium-envoy   ClusterIP   None            &lt;none&gt;        9964/TCP   97s
service/hubble-peer    ClusterIP   10.96.163.128   &lt;none&gt;        443/TCP    97s

NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/cilium         3         3         2       3            2           kubernetes.io/os=linux   97s
daemonset.apps/cilium-envoy   3         3         3       3            3           kubernetes.io/os=linux   97s

NAME                              READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cilium-operator   2/2     2            2           97s

NAME                                         DESIRED   CURRENT   READY   AGE
replicaset.apps/cilium-operator-59944f4b8f   2         2         2       97s
</code></pre>
<h4 id="understanding-the-components">Understanding the Components</h4>
<p><strong>1</strong> <strong>Pods</strong>:<br />
    * cilium-xxxxx: These are <strong>Cilium agent pods</strong> running as DaemonSet. They enforce network policies and provide observability.<br />
    * cilium-envoy-xxxxx: These are <strong>Envoy proxy pods</strong> deployed as DaemonSet, used for L7 policies and load balancing.<br />
    * cilium-operator-xxxxx: These are <strong>Cilium operator pods</strong> deployed as a Deployment. They manage network policies, IPAM (IP address management), and other Kubernetes interactions.  </p>
<p><strong>2</strong> <strong>Services</strong>:
    * cilium-envoy: A ClusterIP service used for managing Envoy instances.<br />
    * hubble-peer: A ClusterIP service facilitating <strong>Hubble</strong>, Cilium‚Äôs network observability tool.  </p>
<p><strong>3</strong> <strong>DaemonSets</strong>:<br />
    * cilium: Ensures that the Cilium agent runs on every node.<br />
    * cilium-envoy: Ensures that an Envoy proxy instance runs on each node.  </p>
<p><strong>4</strong> <strong>Deployment &amp; ReplicaSet</strong>:
    * cilium-operator: Runs in HA mode with <strong>two replicas</strong>, responsible for managing IPAM, policies, and interactions with Kubernetes.<br />
    * cilium-operator-59944f4b8f: The associated ReplicaSet ensuring the operator maintains the desired state.  </p>
<p><img alt="" src="../images/adv/02.png" /></p>
<h3 id="smoke-test-cilium">Smoke Test Cilium</h3>
<p>Install Cilium CLI </p>
<pre><code>CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ &quot;$(uname -m)&quot; = &quot;aarch64&quot; ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}

</code></pre>
<p>To check cilium installation readiness</p>
<pre><code>cilium status --wait

</code></pre>
<p>[sample output ]</p>
<pre><code>    /¬Ø¬Ø\
 /¬Ø¬Ø\__/¬Ø¬Ø\    Cilium:             OK
 \__/¬Ø¬Ø\__/    Operator:           OK
 /¬Ø¬Ø\__/¬Ø¬Ø\    Envoy DaemonSet:    OK
 \__/¬Ø¬Ø\__/    Hubble Relay:       disabled
    \__/       ClusterMesh:        disabled

DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3
DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3
Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2
Containers:            cilium                   Running: 3
                       cilium-envoy             Running: 3
                       cilium-operator          Running: 2
                       clustermesh-apiserver
                       hubble-relay
Cluster Pods:          3/3 managed by Cilium
Helm chart version:    1.17.2
Image versions         cilium             quay.io/cilium/cilium:v1.17.2@sha256:3c4c9932b5d8368619cb922a497ff2ebc8def5f41c18e410bcc84025fcd385b1: 3
                       cilium-envoy       quay.io/cilium/cilium-envoy:v1.31.5-1741765102-efed3defcc70ab5b263a0fc44c93d316b846a211@sha256:377c78c13d2731f3720f931721ee309159e782d882251709cb0fac3b42c03f4b: 3
                       cilium-operator    quay.io/cilium/operator-generic:v1.17.2@sha256:81f2d7198366e8dec2903a3a8361e4c68d47d19c68a0d42f0b7b6e3f0523f249: 2
</code></pre>
<h2 id="enable-observability-with-hubble">Enable Observability with Hubble</h2>
<pre><code>cilium hubble enable
cilium hubble enable --ui
</code></pre>
<p>validate </p>
<pre><code># run this after a minute or so (give it some time to setup)
cilium status
kubectl  get pods -n kube-system
</code></pre>
<p>[sample output]</p>
<pre><code>    /¬Ø¬Ø\
 /¬Ø¬Ø\__/¬Ø¬Ø\    Cilium:             OK
 \__/¬Ø¬Ø\__/    Operator:           OK
 /¬Ø¬Ø\__/¬Ø¬Ø\    Envoy DaemonSet:    OK
 \__/¬Ø¬Ø\__/    Hubble Relay:       OK
    \__/       ClusterMesh:        disabled

DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3
DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3
Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2
Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1
Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1
Containers:            cilium                   Running: 3
                       cilium-envoy             Running: 3
                       cilium-operator          Running: 2
                       clustermesh-apiserver
                       hubble-relay             Running: 1
                       hubble-ui                Running: 1
Cluster Pods:          11/11 managed by Cilium
Helm chart version:    1.17.2
Image versions         cilium             quay.io/cilium/cilium:v1.17.2@sha256:3c4c9932b5d8368619cb922a497ff2ebc8def5f41c18e410bcc84025fcd385b1: 3
                       cilium-envoy       quay.io/cilium/cilium-envoy:v1.31.5-1741765102-efed3defcc70ab5b263a0fc44c93d316b846a211@sha256:377c78c13d2731f3720f931721ee309159e782d882251709cb0fac3b42c03f4b: 3
                       cilium-operator    quay.io/cilium/operator-generic:v1.17.2@sha256:81f2d7198366e8dec2903a3a8361e4c68d47d19c68a0d42f0b7b6e3f0523f249: 2
                       hubble-relay       quay.io/cilium/hubble-relay:v1.17.2@sha256:42a8db5c256c516cacb5b8937c321b2373ad7a6b0a1e5a5120d5028433d586cc: 1
                       hubble-ui          quay.io/cilium/hubble-ui-backend:v0.13.2@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15: 1
                       hubble-ui          quay.io/cilium/hubble-ui:v0.13.2@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392: 1
</code></pre>
<p>Expose hubble service and make it available on  <code>30200</code> nodeport as, </p>
<pre><code>kubectl patch svc hubble-ui -n kube-system --type='json' -p '[{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/type&quot;,&quot;value&quot;:&quot;NodePort&quot;},{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/ports/0/nodePort&quot;,&quot;value&quot;:30200}]'

</code></pre>
<pre><code>kubectl  get svc  -n kube-system
</code></pre>
<p>[sample output ]</p>
<pre><code>NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE
cilium-envoy   ClusterIP   None            &lt;none&gt;        9964/TCP                 4h24m
hubble-peer    ClusterIP   10.96.163.128   &lt;none&gt;        443/TCP                  4h24m
hubble-relay   ClusterIP   10.96.48.239    &lt;none&gt;        80/TCP                   6m12s
hubble-ui      NodePort    10.96.200.6     &lt;none&gt;        80:30200/TCP             4m54s
kube-dns       ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4h29m
</code></pre>
<p>To find out your ip use </p>
<pre><code>curl ifconfig.me
</code></pre>
<p>Now you should be able to access hubble UI using <code>http://IPADDRESS:30200</code></p>
<p><img alt="" src="../images/adv/03.png" /></p>
<p>Thats it, you now have a working cilium cluster with observability enabled.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../adv_service_networking/" class="btn btn-neutral float-left" title="Lab K803 - Service Networking and Kube Proxy"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../adv_explore_cilium/" class="btn btn-neutral float-right" title="Lab K804 - Exploring Cilium">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright @ 2017-2020 Gourav Shah, School of Devops. Some rights reserved. License CC BY-NC-SA</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/schoolofdevops/kubernetes-labguide" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../adv_service_networking/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../adv_explore_cilium/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
